---

- hosts: probe
  tasks:
    - name: copy private keys
      copy:
        src: '{{ item }}'
        dest: '/tmp/{{ item }}'
        mode: '0600'
      loop:
        - beth
        - claire
        - daisy


- hosts: sshd
  roles:
    - test
  vars:
    authorized_keys_present:
      root:
        - beth.pub
        - claire.pub
        - daisy.pub
      alice:
        - beth.pub
        - claire.pub
        - daisy.pub


- hosts: probe
  tasks:
    - name: Everyone pings over ssh
      shell: ssh -o 'StrictHostKeyChecking false' -l {{item.user}} -i /tmp/{{item.key}} sshd exit
      loop:
        - {user: "root", key: "beth"}
        - {user: "root", key: "claire"}
        - {user: "root", key: "daisy"}
        - {user: "alice", key: "beth"}
        - {user: "alice", key: "claire"}
        - {user: "alice", key: "daisy"}


- hosts: sshd
  roles:
    - test
  vars:
    authorized_keys_present:
      root: []
      alice: []
    authorized_keys_absent:
      - daisy.pub


- hosts: probe
  tasks:
    - name: Daisy pings over ssh
      shell: ssh -q -o 'StrictHostKeyChecking false' -l {{item.user}} -i /tmp/{{item.key}} sshd exit
      loop:
        - {user: "root", key: "daisy"}
        - {user: "alice", key: "daisy"}
      register: ping_over_ssh
      ignore_errors: true

    - name: Assert Daisy's ping failed
      fail:
        msg: 'Daisy unexpectedly logged in'
      when: '[255, 255] != (ping_over_ssh.results |map(attribute="rc") |list)'
